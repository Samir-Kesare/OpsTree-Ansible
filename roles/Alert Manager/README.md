#  Ansible Role for Alert Manager

![image](https://github.com/CodeOps-Hub/Ansible/assets/156056570/26b8faf6-96af-45e5-9184-c47646ae8b1c)

***

| **Author** | **Created on** | **Last Updated** | **Document Version** |
| ---------- | -------------- | ---------------- | -------------------- |
| **Samir** | **1-04-2024** | **1-04-2024** | **v1** |

***
# Table of contents
* [Introduction](#Introduction)
* [Flow Diagram](#Flow-Diagram)
* [Pre-requisites](#Pre-requisites)
* [Directory Structure](#Directory-Structure)
* [Output](#Output)
* [Conclusion](#Conclusion)
* [Contact Information](#Contact-Information)
* [References](#References)

***

# Introduction
The Alert Manager role is responsible for managing and processing alerts generated by monitoring systems such as Prometheus. It provides a powerful alerting system that allows you to
define alert rules, handle alerts, and route notifications to various channels.
***

# Flow Diagram

![image](https://github.com/CodeOps-Hub/Ansible/assets/156056570/551c234d-1048-4994-9b05-5f4307dfea94)


***

# Pre-requisites

| **Pre-requisite** | **Description** |
| ----------------- | --------------- |
| **Ansible**       | Ansible must be installed on the control machine from which you plan to run the playbook. |
| **AWS CLI**       | AWS CLI for providing aws credentials to fetch resources. |
| **Python**        | Ensure that Python is installed on your system. Ansible relies on Python for its execution, and dynamic inventory scripts are typically written in Python. |
| **PIP (Python Package Installer)** | Install pip if it's not already installed. pip is a package manager for Python that allows you to install and manage Python packages. |
| **Boto3**   |  If your dynamic inventory script relies on AWS APIs to fetch inventory data, you'll need to install `boto3` using `pip`. |

***

# Directory Structure

![Screenshot 2024-04-01 at 1 11 15 AM](https://github.com/CodeOps-Hub/Ansible/assets/156056364/170b5332-9aca-4950-aa1a-7e19ae53727e)
***

# Dynamic Inventory Setup

### ansible.cfg

<details>
<summary> ansible.cfg </summary>
<br>
  
```shell
[defaults]
# some basic default values...
inventory               =       ./aws_ec2.yaml
private_key_file        =       ./samir.pem
remote_user             =       ubuntu
host_key_checking       =       False
[inventory]
enable_plugins          =       aws_ec2
```
</details>

***

### aws_ec2.yml

<details>
<summary> aws_ec2.yml </summary>
<br>
  
```shell
---
plugin: aws_ec2
regions:
  - ap-northeast-1
filters:
    instance-state-code: 16
keyed_groups:
  - key: tags
    prefix: tag

```
</details>

***

### playbook.yml

<details>
<summary> playbook.yml </summary>
<br>
  
```shell
---
- hosts: aws_ec2
  become: yes
  gather_facts: yes
  roles:
    - alert_manager_role

```
</details>

***

##  alert_manager_role

### defaults

The defaults/main.yml file helps maintain consistency and simplifies role configuration by defining default values for variables. 

<details>
<summary> main.yml </summary>
<br>
  
```shell
---
alert_manager_port: 9093
alert_manager_config_file: /etc/alertmanager/alertmanager.yml
alert_manager_binary_url: "https://github.com/prometheus/alertmanager/releases/download/v{{ alert_manager_version }}/alertmanager-{{ alert_manager_version }}.linux-amd64.tar.gz"
alert_manager_version: "0.23.0"


```
</details>

***
### handlers


<details>
<summary> main.yml </summary>
<br>
  
```shell
- name: Restart Alert Manager
  systemd:
    name: alertmanager
    state: restarted


```
</details>

***
### templates/alertmanager.yml.j2


<details>
<summary> main.yml </summary>
<br>
  
```shell
global:
  resolve_timeout: 5m

route:
  receiver: 'null'

receivers:
- name: 'null'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']

    - source_match:
        severity: 'warning'
      target_match:
        severity: 'critical'
      equal: ['alertname', 'dev', 'instance']


```
</details>

***
### templates/alertmanager.service.j2


<details>
<summary> main.yml </summary>
<br>
  
```shell
[Unit]
Description=Alert Manager
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
ExecStart=/usr/local/bin/alertmanager --config.file={{ alert_manager_config_file }}
Restart=always

[Install]
WantedBy=multi-user.target

```
</details>

***
### tasks

This playbook automates the setup process, ensuring a smooth installation and configuration of Prometheus on the target system.

<details>
<summary> Click here to see main.yml file</summary>
<br>
  
```shell
---
- name: Install required dependencies
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - wget
    - tar

- name: Download Alert Manager binary
  get_url:
    url: "{{ alert_manager_binary_url }}"
    dest: "/tmp/alertmanager-{{ alert_manager_version }}.tar.gz"

- name: Extract Alert Manager binary
  become: true
  unarchive:
    src: "/tmp/alertmanager-{{ alert_manager_version }}.tar.gz"
    dest: /usr/local/bin
    remote_src: yes

- name: Create directory for Alert Manager configuration
  file:
    path: "{{ alert_manager_config_file | dirname }}"
    state: directory

- name: Generate Alert Manager configuration file
  template:
    src: alertmanager.yml.j2
    dest: "{{ alert_manager_config_file }}"
  notify: Restart Alert Manager

- name: Install systemd service
  template:
    src: alertmanager.service.j2
    dest: /etc/systemd/system/alertmanager.service
  notify: Restart Alert Manager

- name: Start Alert Manager service
  systemd:
    name: alertmanager
    state: started
    enabled: yes

```
</details>

***


***

# Output

### alert_manager_role Execution

***

### alert_manager_role varification
![Screenshot 2024-04-01 at 1 23 14 AM](https://github.com/CodeOps-Hub/Ansible/assets/156056364/36f6f1c6-dacf-49cc-9b9b-b4de656ebcf1)

***

# Conclusion

In conclusion, the Alert Manager role serves as a vital component in a monitoring and alerting infrastructure, enabling organizations to effectively manage and respond to alerts generated by Prometheus and other monitoring systems. By providing a robust alerting system with features such as rule definition, lifecycle management, and notification integration, the Alert Manager role empowers teams to proactively monitor their systems, detect anomalies, and take timely action to mitigate potential issues.

***

# Contact Information

| **Name** | **Email Address** |
| -------- | ----------------- |
| **Samir** | samir.kesare.snaatak@mygurukulam.co |

***

# References

| **Source** | **Description** |
| ---------- | --------------- |
| [Link](https://docs.ansible.com/ansible/latest/index.html) | Ansible Doc Link. |
| [Link](https://www.youtube.com/watch?v=junPdh2yvbU&t=454s) | Reference Link For Ansible Dynamic Inventory. |
